{
  "hash": "53b1e14c8ea2202bae7e9706779cd633",
  "result": {
    "engine": "knitr",
    "markdown": "\n\n\n\n# Advanced Visualization  {-}\n\n\n\n## Network Visualization {-}\n\nRead in the Capital Bikeshare data from the last quarter of 2014:\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in gzfile(file, \"rb\"): cannot open compressed file\n'data/2014-Q4-Trips-History-Data.rds', probable reason 'No such file or\ndirectory'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-error}\n\n```\nError in gzfile(file, \"rb\"): cannot open the connection\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in file(file, \"rt\"): cannot open file 'data/DC-Stations.csv': No such\nfile or directory\n```\n\n\n:::\n\n::: {.cell-output .cell-output-error}\n\n```\nError in file(file, \"rt\"): cannot open the connection\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_site <-\n  \"https://bcheggeseth.github.io/112_fall_2022/data/2014-Q4-Trips-History-Data-Small.rds\"\nTrips <- readRDS(gzcon(url(data_site)))\nStations <- read_csv(\"https://bcheggeseth.github.io/112_fall_2022/data/DC-Stations.csv\")\n```\n:::\n\n\n\n\nOne way to plot networks is to just use the `geom_segment` function in `ggplot`. Here is an example where we compute the bike ride flows between each pair of stations, keeping the data faceted by `client` and `is_weekend`, and filtering out low traffic links:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nTrafficFlow <- Trips %>%\n  mutate(is_weekend = ifelse(lubridate::wday(sdate) %in% c(1, 7), \"weekend\", \"weekday\")) %>%\n  group_by(sstation, estation, client, is_weekend) %>%\n  summarise(flow = n()) %>%\n  left_join(Stations %>% select(name, lat, long), by = c(\"sstation\" = \"name\")) %>%\n  rename(slat = lat) %>%\n  rename(slong = long) %>%\n  left_join(Stations %>% select(name, lat, long), by = c(\"estation\" = \"name\")) %>%\n  rename(elat = lat) %>%\n  rename(elong = long) %>%\n  filter(!is.na(slat) & !is.na(slong) & !is.na(elat) & !is.na(elong))\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'Trips' not found\n```\n\n\n:::\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'TrafficFlow' not found\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmyMap <- get_stamenmap(c(-77.1, 38.87, -76.975, 38.95), zoom = 14, maptype = \"terrain\") # centered at Logan Circle\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in get_stamenmap(c(-77.1, 38.87, -76.975, 38.95), zoom = 14, maptype = \"terrain\"): Stamen map tiles are now hosted by Stadia Maps, use `get_stadiamap()`.\n```\n\n\n:::\n\n```{.r .cell-code}\n# myMap<-get_map(location=\"Logan Circle\",source=\"google\",maptype=\"roadmap\",zoom=13)\n```\n:::\n\n\n\nPlot data on the whole network:\n\n\n\n::: {.cell fig.fullwidth='true'}\n\n```{.r .cell-code}\nthresh <- .04\nmax_flow <- max(TrafficFlow$flow)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'TrafficFlow' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nTrafficFlow <- TrafficFlow %>%\n  mutate(weight = flow / max_flow) %>%\n  filter(weight > thresh)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'TrafficFlow' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nggmap(myMap) +\n  geom_point(data = Stations, size = 2, color = \"red\", aes(x = long, y = lat)) +\n  geom_segment(data = TrafficFlow, aes(x = slong, xend = elong, y = slat, yend = elat, alpha = weight / 2), arrow = arrow(length = unit(0.03, \"npc\")), color = \"red\") +\n  facet_grid(client ~ is_weekend)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'myMap' not found\n```\n\n\n:::\n:::\n\n\n\n\n\n## Animations with `gganimate` {-}\n\n\n\nThe `gganimate` package animates a series of plots. Here are some resources:   \n\n1. [gganimate intro slides by Katherine Good](https://goodekat.github.io/presentations/2019-isugg-gganimate-spooky/slides.html#1)\n\n2. [gganimate cheat sheet](https://ugoproto.github.io/ugo_r_doc/pdf/gganimate.pdf)\n\n3. [gganimate by Thomas Pedersen](https://github.com/thomasp85/gganimate)\n\n4. [Pedersen introductory vignette](https://cran.r-project.org/web/packages/gganimate/vignettes/gganimate.html)\n\n5. [gganimate wiki page](https://github.com/thomasp85/gganimate/wiki)\n\n6. [ropensci examples](https://github.com/ropensci-archive/learngganimate)\n\nLet's do one example here. First we create a static plot of a single bike moving around town.\n\nIdentify a busy bike:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbusyBikes <- Trips %>%\n  group_by(bikeno) %>%\n  summarise(count = n()) %>%\n  arrange(desc(count)) %>%\n  head(3)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'Trips' not found\n```\n\n\n:::\n:::\n\n\n\nGather and tidy all data for that bike:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsingleBike <- Trips %>%\n  filter(bikeno == busyBikes$bikeno[1]) %>%\n  arrange(sdate) %>%\n  select(sdate, sstation, edate, estation)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'Trips' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nsingleTidy <- bind_rows(\n  singleBike %>%\n    select(date = sdate, station = sstation) %>%\n    mutate(key = \"start\"),\n  singleBike %>%\n    select(date = edate, station = estation) %>%\n    mutate(key = \"end\")\n) %>%\n  arrange(date) %>%\n  left_join(Stations, by = c(\"station\" = \"name\"))\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'singleBike' not found\n```\n\n\n:::\n:::\n\n\n\nPlot the movements of the bike over the first week:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstops <- singleTidy %>%\n  select(station, lat, long, date) %>%\n  head(102) %>%\n  mutate(elapsed_hours = as.numeric(difftime(date, date[1], units = \"hours\"))) %>%\n  mutate(order = 1:102)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'singleTidy' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nggmap(myMap) +\n  geom_path(data = stops, aes(x = long, y = lat, color = elapsed_hours), size = 1.3) +\n  scale_color_distiller(palette = \"Reds\") +\n  labs(color = \"Elapsed Hours\")\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'myMap' not found\n```\n\n\n:::\n:::\n\n\n\n\nNow let's animate the plot with `gganimate`: \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(gganimate)\nlibrary(av)\n\npp_anim <- ggmap(myMap) +\n  geom_path(data = stops, aes(x = long, y = lat, color = elapsed_hours), size = 1.3) +\n  scale_color_distiller(palette = \"Reds\") +\n  labs(color = \"Elapsed Hours\", title = \"Date and Time: {frame_along}\") +\n  transition_reveal(date)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'myMap' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nanimate(pp_anim, fps = 1, start_pause = 2, end_pause = 15, renderer = av_renderer())\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'pp_anim' not found\n```\n\n\n:::\n:::\n\n\n\nThe animations above do not allow for interactivity. We'll explore different methods to include [interactivity](http://r4ds.had.co.nz/r-markdown-formats.html#interactivity) in the following sections.\n\n\n## Interactive Visualizations {-}\n\nAdditional reading:        \n\n1. [Interactivity](http://r4ds.had.co.nz/r-markdown-formats.html#interactivity) in R for Data Science by Grolemund and Wickham.  \n2. [http://www.htmlwidgets.org/](http://www.htmlwidgets.org/)  \n\n\n### htmlwidgets {-}\n\nDifferent htmlwidgets allow you to take advantage of the interactivity of html when generating graphics. Different types of widgets have been designed for different types of visualizations. In general, I found all of these easy to learn and use (i.e., I could get them up and running on an example I had in mind in under an hour). \n\n#### leaflet for interactive maps {-}\n\nThe [leaflet](https://rstudio.github.io/leaflet/) htmlwidget allows you to easily create interactive maps. Just like `ggplot`, you add different layers to the visualiation (a \"Tiles\"\" layer for a background map, different types of \"Markers\", points lines, etc.). I found it super easy to learn and use. Here is an example:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(leaflet)\npal <- colorNumeric(\n  palette = \"Greys\",\n  domain = stops$order, reverse = TRUE\n)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'stops' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nleaflet(stops) %>%\n  setView(-77.0296, 38.9096, zoom = 13) %>% # Logan Circle coords\n  addProviderTiles(\"OpenStreetMap.Mapnik\") %>% # this fixes a bug in addTiles() %>%\n  addCircleMarkers(\n    lat = ~lat, lng = ~long, color = ~ pal(order),\n    popup = ~ paste(as.character(order), \": \", station, sep = \"\")\n  ) %>%\n  addPolylines(lat = ~lat, lng = ~long)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'stops' not found\n```\n\n\n:::\n:::\n\n\n\n#### dygraphs {-}\n\nThe [dygraph pacakge](http://rstudio.github.io/dygraphs/) allows us to generate interactive time series charts.\n\nI am interested in how often the van needs to come by and pick up or drop off bicycles at different stations. So I want to look at the net daily departures at each station; that is, the number of departures minus the number of arrivals.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnum_daily_departures <- Trips %>%\n  mutate(month = lubridate::month(sdate)) %>%\n  mutate(day = lubridate::day(sdate)) %>%\n  group_by(month, day, sstation) %>%\n  summarise(num_departures = n())\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'Trips' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nnum_daily_arrivals <- Trips %>%\n  mutate(month = lubridate::month(edate)) %>%\n  mutate(day = lubridate::day(edate)) %>%\n  group_by(month, day, estation) %>%\n  filter(month > 9) %>%\n  summarise(num_arrivals = n())\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'Trips' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nNetTraffic <- num_daily_departures %>%\n  full_join(num_daily_arrivals, by = c(\"sstation\" = \"estation\", \"month\" = \"month\", \"day\" = \"day\"))\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'num_daily_departures' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nNetTraffic[is.na(NetTraffic)] <- 0\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError: object 'NetTraffic' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nNetTraffic <- NetTraffic %>%\n  mutate(total_events = num_departures + num_arrivals) %>%\n  mutate(net_departures = num_departures - num_arrivals) %>%\n  rename(station = sstation) %>%\n  group_by(station) %>%\n  mutate(tot = sum(total_events)) %>%\n  filter(tot > 6000) %>%\n  ungroup() %>%\n  mutate(date = ymd(paste(\"2014\", as.character(month), as.character(day), sep = \"\"))) %>%\n  mutate(wday = wday(date, label = TRUE))\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'NetTraffic' not found\n```\n\n\n:::\n:::\n\n::: {.cell fig.fullwidth='true'}\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'NetTraffic' not found\n```\n\n\n:::\n:::\n\n\n\nLet's plot the net daily departures for four different stations. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nNetTrafficSelect <- NetTraffic %>%\n  filter(station %in% c(\"Massachusetts Ave & Dupont Circle NW\", \"16th & Harvard St NW\", \"Lincoln Memorial\", \"Columbus Circle / Union Station\")) %>%\n  select(date, station, net_departures)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'NetTraffic' not found\n```\n\n\n:::\n:::\n\n\n\nNote that dygraphs wants each time series in a separate column, as opposed to the tidy format in which you would want it for `ggplot`. It also wants it in the `xts` format. We can fix this with a `spread` command:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(xts)\nNetTrafficSelectWide <- NetTrafficSelect %>%\n  spread(key = station, value = net_departures)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'NetTrafficSelect' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nNetTrafficSelectXTS <- xts(NetTrafficSelectWide[, 2:5], order.by = NetTrafficSelectWide$date)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'NetTrafficSelectWide' not found\n```\n\n\n:::\n:::\n\n\n\nAnd now we are ready to create the visualization. Note how you can hover over points to see the values or use the range selector to adjust the domain on the x-axis.\n\n\n\n::: {.cell fig.fullwidth='true'}\n\n```{.r .cell-code}\nlibrary(dygraphs)\ndygraph(NetTrafficSelectXTS, main = \"Daily Net Departures at Four Select Stations\") %>%\n  dyRangeSelector() %>%\n  dyOptions(\n    drawPoints = TRUE,\n    pointSize = 5,\n    strokeWidth = 3,\n    colors = RColorBrewer::brewer.pal(4, \"Set2\")\n  ) %>%\n  dyLegend(width = 1200)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in dygraph(NetTrafficSelectXTS, main = \"Daily Net Departures at Four\nSelect Stations\"): restarting interrupted promise evaluation\n```\n\n\n:::\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'NetTrafficSelectXTS' not found\n```\n\n\n:::\n:::\n\n\n\n#### plotly (d3) {-}\n\nThe `plotly` package is a super convenient way to incorporate many of the cool features of d3 into your graphics without having to learn anything about d3 programming. This might be my favorite widget so far, because all you have to do is make your regular graphic with `ggplot` and then pass it to the function `ggplotly`. \n\n\n\n::: {.cell fig.fullwidth='true'}\n\n```{.r .cell-code}\nlibrary(plotly)\np <- ggplot(\n  NetTrafficSelect,\n  aes(x = date, y = net_departures, fill = station)\n) +\n  geom_col(position = \"dodge\")\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'NetTrafficSelect' not found\n```\n\n\n:::\n\n```{.r .cell-code}\nggplotly(p)\n```\n\n::: {.cell-output .cell-output-error}\n\n```\nError in eval(expr, envir, enclos): object 'p' not found\n```\n\n\n:::\n:::\n\n\n\nNote all of the extra functionality we get:\n\n- You can turn individual time series on and off.\n- You can pan and zoom in and out on select areas.\n- You can hover on specific points to see either individual values, or (really cool) compare all values at that date.\n\n\n#### Others {-}\n\nHere is a list of other cool htmlwidgets, along with demos: [http://www.htmlwidgets.org/](http://www.htmlwidgets.org/).\n\n\n\n\n\n### Dashboards {-}\n\nWith the [flexdashboard](http://rmarkdown.rstudio.com/flexdashboard/) package, you can create dashboards with different configurations to display information visually. Each of these panels can include standard `ggplot` figures, htmlwidgets, text, tables, etc. The resulting dashboard is output as an html file that can be opened in a browswer.\n\nYou can check out the source code for each of these demo examples:\n\n- [htmlwidgets showcase storyboard](https://beta.rstudioconnect.com/jjallaire/htmlwidgets-showcase-storyboard/htmlwidgets-showcase-storyboard.html)\n\n- [highcharter dashboard](https://beta.rstudioconnect.com/jjallaire/htmlwidgets-highcharter/htmlwidgets-highcharter.html#best-sellers)\n\n[This page](http://rmarkdown.rstudio.com/flexdashboard/using.html) gives detailed instructions on using this package.\n\n\n### Shiny {-}\n\nAs opposed to htmlwidgets, which leverage JavaScript code to create the interactivity, [Shiny Web Apps](https://shiny.rstudio.com/) use R code to directly build the interactivity. This interactivity is built on the server side, so a Shiny App needs to be hosted on a server, as opposed to an htmlwidget, which can be embedded into the html page.^[Shiny still utilizes JavaScript libraries like d3 and Leaflet.] \n\nWhile this can be more complicated, it also opens the door to more possibilities. For example, if data is continuously being collected by the server, users can access up to date information. Shiny can also be used in conjunction with dashboards. Here are a couple examples:\n\n- [Bus dashboard that is continuously updated](https://shiny.rstudio.com/gallery/bus-dashboard.html)\n- [CRAN downloads](https://jjallaire.shinyapps.io/shiny-crandash/)\n- [Diamond explorer](https://jjallaire.shinyapps.io/shiny-ggplot2-diamonds/)\n\nThe programming paradigm is slightly different than we are used to, because it is [reactive](https://shiny.rstudio.com/articles/reactivity-overview.html).  Here is another [article on understanding reactivity](https://shiny.rstudio.com/articles/understanding-reactivity.html). It points out that when the user changes the input in a Shiny app (e.g., checking a box, moving a slider, filtering out certain variables), \"Shiny is re-running your R expressions in a carefully scheduled way.\"\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}